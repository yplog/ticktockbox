{{define "index"}}{{template "layout" .}}{{end}}

{{define "content"}}
<h2>Job Management</h2>

<form method="GET" style="margin-bottom: 20px; padding: 15px; background: #f5f5f5; border-radius: 5px;">
  <label style="margin-right: 15px;">
    Status: 
    <select name="status" onchange="this.form.submit()">
      {{range .StatusList}}
        <option value="{{.}}" {{if eq . $.Filter.Status}}selected{{end}}>
          {{if eq . "all"}}All{{else}}{{title .}}{{end}}
        </option>
      {{end}}
    </select>
  </label>
  
  <label style="margin-right: 15px;">
    Per Page: 
    <select name="limit" onchange="this.form.submit()">
      <option value="10" {{if eq $.Filter.Limit 10}}selected{{end}}>10</option>
      <option value="25" {{if eq $.Filter.Limit 25}}selected{{end}}>25</option>
      <option value="50" {{if eq $.Filter.Limit 50}}selected{{end}}>50</option>
      <option value="100" {{if eq $.Filter.Limit 100}}selected{{end}}>100</option>
    </select>
  </label>
  
  <input type="hidden" name="page" value="1">

  <label style="margin-left: 20px;">
    <input type="checkbox" id="view-browser-tz" onchange="toggleBrowserTZ(this)"> View times in my timezone
  </label>
</form>

<div style="margin-bottom: 15px; padding: 10px; background: #e3f2fd; border-radius: 5px;">
  <strong>Total: {{.Page.Total}} jobs</strong> | 
  Page {{.Page.Page}} of {{.Page.TotalPages}} | 
  Showing {{len .Rows}} results
</div>

<table>
  <thead>
    <tr>
      <th>ID</th>
      <th>Title</th>
      <th>TZ</th>
      <th>Run (job TZ)</th>
      <th>Due (job TZ)</th>
      <th>Due (my TZ)</th>
      <th>Due in</th>
      <th>Status</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody>
  {{range .Rows}}
    <tr>
      <td>{{.ID}}</td>
      <td>{{.Title}}</td>
      <td>{{.TZ}}</td>
      <td class="dt-run" data-utc="{{rfc3339 .RunAtUTC}}" data-local="{{.RunAtLocal}}">{{.RunAtLocal}}</td>
      <td class="dt-due" data-utc="{{rfc3339 .DueAtUTC}}" data-local="{{.DueAtLocal}}">{{.DueAtLocal}}</td>
      <td class="dt-due-browser" data-utc="{{rfc3339 .DueAtUTC}}"></td>
      <td class="dt-duein" data-utc="{{rfc3339 .DueAtUTC}}" data-status="{{.Status}}">{{.DueIn}}</td>
      <td>
        <span style="padding: 2px 6px; border-radius: 3px; font-size: 0.8em; 
          {{if eq .Status "pending"}}background: #fff3cd; color: #856404;{{end}}
          {{if eq .Status "enqueued"}}background: #d1ecf1; color: #0c5460;{{end}}
          {{if eq .Status "cancelled"}}background: #f8d7da; color: #721c24;{{end}}">
          {{.Status}}
        </span>
      </td>
      <td>
        {{if eq .Status "pending"}}
          <form method="post" action="/jobs/{{.ID}}/cancel" style="display: inline;">
            <button type="submit" style="font-size: 0.8em; padding: 2px 6px;">Cancel</button>
          </form>
        {{end}}
      </td>
    </tr>
  {{else}}
    <tr><td colspan="9">No jobs found.</td></tr>
  {{end}}
  </tbody>
</table>

<!-- Pagination -->
{{if gt .Page.TotalPages 1}}
<div class="pagination">
  {{if .Page.HasPrev}}
    <a href="?status={{.Filter.Status}}&limit={{.Filter.Limit}}&page=1">First</a>
    <a href="?status={{.Filter.Status}}&limit={{.Filter.Limit}}&page={{sub .Page.Page 1}}">Previous</a>
  {{end}}
  
  <!-- Page numbers (show current and 2 pages around it) -->
  {{$currentPage := .Page.Page}}
  {{$totalPages := .Page.TotalPages}}
  {{$start := sub $currentPage 2}}
  {{if lt $start 1}}{{$start = 1}}{{end}}
  {{$end := add $currentPage 2}}
  {{if gt $end $totalPages}}{{$end = $totalPages}}{{end}}
  
  {{range seq $start $end}}
    {{if eq . $currentPage}}
      <span class="current">{{.}}</span>
    {{else}}
      <a href="?status={{$.Filter.Status}}&limit={{$.Filter.Limit}}&page={{.}}">{{.}}</a>
    {{end}}
  {{end}}
  
  {{if .Page.HasNext}}
    <a href="?status={{.Filter.Status}}&limit={{.Filter.Limit}}&page={{add .Page.Page 1}}">Next</a>
    <a href="?status={{.Filter.Status}}&limit={{.Filter.Limit}}&page={{.Page.TotalPages}}">Last</a>
  {{end}}
</div>
{{end}}
{{end}}
